<!-- Generated by GAS WebApp Builder | By. Syarif Hidayatullah -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-head-title">Sistem Aplikasi Warga</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for Dashboard Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        
        /* Minimalist Elements */
        .form-control, .form-select { border-radius: 8px; border: 1px solid #dee2e6; box-shadow: none !important; }
        .form-control:focus, .form-select:focus { border-color: #3498db; }
        .btn { border-radius: 8px; font-weight: 500; transition: all 0.2s; }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s; background: #fff; }
        
        /* Table Minimalist */
        .table { font-size: 0.95rem; vertical-align: middle; }
        .table-light th { background-color: #f4f6f8; color: #495057; border-bottom: 2px solid #e9ecef; font-weight: 600; border-top: none; border-left: none; border-right: none;}
        .table td { border-bottom: 1px solid #f1f3f5; border-top: none; border-left: none; border-right: none; }
        
        .sidebar { background: #1e293b; color: white; min-height: 100vh; padding: 20px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .nav-link { color: rgba(255,255,255,0.7); margin-bottom: 4px; padding: 10px 20px; border-radius: 0 20px 20px 0; margin-right: 20px; transition: 0.3s; cursor: pointer; font-weight: 500;}
        .nav-link:hover, .nav-link.active { background: #3b82f6; color: white; }
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .navbar-top { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.02); padding: 15px 25px; margin-bottom: 20px;}
        #app-container { display: none; }
        
        .bg-grad-primary { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
        .bg-grad-success { background: linear-gradient(135deg, #10b981, #34d399); }
        .bg-grad-warning { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .bg-grad-info { background: linear-gradient(135deg, #0ea5e9, #38bdf8); }
        .bg-grad-dark { background: linear-gradient(135deg, #334155, #475569); }
        .dash-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); }

        /* Sidebar Mobile Responsive */
        @media (max-width: 767.98px) {
            .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100vh; z-index: 1050; transition: left 0.3s ease; display: block !important; overflow-y: auto; }
            .sidebar.show { left: 0; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 1040; display: none; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(2px);}
            .sidebar-overlay.show { display: block; opacity: 1; }
        }

        /* Animated Login Background */
        .login-bg {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #3b82f6, #1e293b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        /* ID Card Design */
        .id-card { width: 100%; max-width: 350px; margin: 0 auto; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.1); background: #fff; border: 1px solid #eee; }
        .id-card-header { background: linear-gradient(135deg, #1e293b, #3b82f6); color: white; text-align: center; padding: 18px 10px; }
        .id-card-body { padding: 25px; position: relative; }
        .id-card-photo { width: 85px; height: 110px; background: #f1f5f9; border: 2px dashed #cbd5e1; position: absolute; right: 20px; top: 25px; display: flex; align-items: center; justify-content: center; color: #94a3b8; border-radius: 8px; overflow: hidden; }
        .id-card-photo img { width: 100%; height: 100%; object-fit: cover; }
        .id-card-info { margin-right: 100px; font-size: 0.9rem; color: #475569;}
        .id-card-info p { margin-bottom: 6px; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loader-overlay" id="loader">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h6 id="loader-text" class="text-secondary fw-bold">Sedang memproses...</h6>
    </div>

    <!-- VIEW: LOGIN -->
    <div id="login-view" class="login-bg">
        <div class="container">
            <div class="row justify-content-center w-100 m-0">
                <div class="col-md-5 col-lg-4 col-11 px-1">
                    <div class="card p-4 login-card">
                        <div class="text-center mb-4">
                            <div id="login-app-logo"><i class="fas fa-building fa-3x text-primary mb-3"></i></div>
                            <h4 id="login-app-name" class="fw-bold text-dark mb-1">Sistem Manajemen RT</h4>
                            <p class="text-muted small mb-0">Platform Digital Modern</p>
                        </div>

                        <form id="loginForm" onsubmit="handleLogin(event)">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-secondary small mb-1">Username / NIK</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="login_username" placeholder="Ketik Username / NIK" required>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold text-secondary small mb-1">Password</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control border-start-0 ps-0" id="login_password" placeholder="Ketik Password" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin">Masuk Aplikasi <i class="fas fa-arrow-right ms-2"></i></button>
                        </form>
                    </div>
                    <footer class="text-center mt-4 text-white-50">
                        <small>Aplikasi Manajemen Warga<br><b class="text-white">By. Syarif Hidayatullah</b></small>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: MAIN APP -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="app-container" class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar d-flex flex-column" id="app-sidebar">
                <div class="text-center mb-4 px-3 pb-3">
                    <h5 class="mb-0 text-white" id="sidebar-app-name" style="font-size: 1.1rem; line-height: 1.4;"><i class="fas fa-cube text-primary me-2"></i>Aplikasi RT</h5>
                    <div class="mt-2"><small class="badge bg-primary bg-opacity-25 text-light rounded-pill px-3 py-1" id="sidebar-kode-rt">Loading...</small></div>
                </div>
                <ul class="nav flex-column mb-auto" id="sidebar-menu">
                    <!-- Dinamis via JS -->
                </ul>
                <div class="text-center mt-auto pt-4 pb-2 px-3">
                    <div class="p-3 bg-dark bg-opacity-50 rounded-3">
                        <small class="text-white-50" style="font-size: 0.7rem;">Developed By</small><br>
                        <span class="text-white fw-bold" style="font-size: 0.85rem;">Syarif Hidayatullah</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 bg-light min-vh-100 d-flex flex-column">
                <div class="navbar-top d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-white shadow-sm d-md-none me-3 rounded-circle text-primary" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                        <h5 class="fw-bold mb-0 text-dark" id="page-title">Dashboard</h5>
                    </div>
                    <div>
                        <span class="me-3 d-none d-sm-inline-block text-secondary fw-medium" id="user-info"><i class="fas fa-user-circle me-1"></i> User</span>
                        <button class="btn btn-danger btn-sm rounded-pill px-3" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-1"></i> Keluar</button>
                    </div>
                </div>

                <div class="p-3 p-md-4 flex-grow-1" id="main-content">
                    <!-- Konten dinamis masuk kesini -->
                </div>
                
                <footer class="text-center mt-auto py-3 bg-white text-muted small">
                    Aplikasi Manajemen Lingkungan &copy; 2026 | Dibuat dengan ‚ù§Ô∏è oleh <b class="text-dark">Syarif Hidayatullah</b>
                </footer>
            </div>
        </div>
    </div>

    <!-- Modal Form Generic -->
    <div class="modal fade" id="formModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Form Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="dataForm" onsubmit="handleFormSubmit(event)">
                    <div class="modal-body" id="form-inputs">
                        <!-- Input digenerate otomatis -->
                    </div>
                    <div class="modal-footer border-top-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary px-4" id="btnSave">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Kartu Anggota Warga -->
    <div class="modal fade" id="cardModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-id-card text-primary me-2"></i>Kartu Warga</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0" id="card-print-area">
                    <div class="id-card text-start mx-auto mt-2">
                        <div class="id-card-header">
                            <h5 class="mb-0 fw-bold">KARTU TANDA WARGA</h5>
                            <small class="text-light opacity-75" id="card-org-name">Nama Organisasi</small>
                        </div>
                        <div class="id-card-body">
                            <div class="id-card-photo" id="modal-card-photo"><i class="fas fa-user fa-3x text-muted"></i></div>
                            <div class="id-card-info">
                                <p class="text-muted small mb-0">NIK</p>
                                <p class="fw-bold mb-2 text-dark" id="card_nik">-</p>
                                <p class="text-muted small mb-0">Nama Lengkap</p>
                                <p class="fw-bold mb-2 text-dark" id="card_nama">-</p>
                                <p class="text-muted small mb-0">Blok / No. Rumah</p>
                                <p class="fw-bold mb-2 text-dark" id="card_blok">-</p>
                                <p class="text-muted small mb-0">Status</p>
                                <p class="fw-bold mb-0"><span id="card_status" class="badge bg-success">-</span></p>
                            </div>
                        </div>
                        <div class="bg-light p-2 text-center border-top text-muted" style="font-size: 0.7rem;">
                            Kartu ini adalah identitas resmi warga lingkungan setempat.
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printCard()"><i class="fas fa-print me-1"></i> Cetak</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Surat Menyurat -->
    <div class="modal fade" id="suratModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-envelope text-primary me-2"></i>Preview Surat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light rounded m-3 p-0" id="surat-print-area">
                    <!-- Konten surat masuk kesini -->
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary px-4" onclick="printSurat()"><i class="fas fa-print me-1"></i> Cetak Surat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- MAIN LOGIC JAVASCRIPT -->
    <script>
        // --- STATE ---
        let currentUser = null;
        let activeMenu = 'Dashboard';
        let currentSheet = '';
        let modalInstance = null;
        let cardModalInstance = null;
        let modalSuratInstance = null;
        let globalWarga = []; 
        let globalMasterRT = [];
        let globalSettings = { NamaAplikasi: 'Sistem Manajemen Lingkungan', LogoUrl: '' }; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            modalInstance = new bootstrap.Modal(document.getElementById('formModal'));
            cardModalInstance = new bootstrap.Modal(document.getElementById('cardModal'));
            modalSuratInstance = new bootstrap.Modal(document.getElementById('suratModal'));
            checkLoginState();
        });

        function startLoading(text = "Sedang memproses...") {
            let loaderText = document.getElementById('loader-text');
            if(loaderText) loaderText.innerText = text;
            let loader = document.getElementById('loader');
            if(loader) loader.style.display = 'flex';
        }

        function endLoading() {
            let loader = document.getElementById('loader');
            if(loader) loader.style.display = 'none';
        }

        // Failsafe Mode Production
        function checkGAS() {
            if (typeof google === 'undefined') {
                endLoading();
                Swal.fire('Akses Ditolak', 'Mode Simulasi telah dimatikan. Aplikasi ini sudah siap pakai dan hanya dapat dijalankan melalui Link URL hasil Deploy Google Apps Script Anda.', 'error');
                return false;
            }
            return true;
        }

        // --- AUTH LOGIC & DATA SYNCRONIZATION ---
        function checkLoginState() {
            const storedUser = localStorage.getItem('rtAppUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            let displayRole = currentUser.role === 'SuperAdmin' ? 'Super Admin' : currentUser.role;
            document.getElementById('user-info').innerHTML = `<i class="fas fa-user-circle me-1"></i> ${currentUser.nama} <span class="d-none d-md-inline-block">(${displayRole})</span>`;
            document.getElementById('sidebar-kode-rt').innerText = currentUser.role === 'SuperAdmin' ? 'ALL SYSTEM' : `KODE: ${currentUser.kodeRT}`;

            renderMenu();

            if (!checkGAS()) return;

            startLoading("Sinkronisasi Sesi Anda...");
            if (currentUser.role === 'SuperAdmin') {
                document.getElementById('sidebar-app-name').innerHTML = `<i class="fas fa-globe me-2 text-primary"></i>Pusat Multi-RT`;
                google.script.run.withSuccessHandler(res => {
                    if(res.success) globalMasterRT = res.data;
                    endLoading(); loadPage('Dashboard');
                }).withFailureHandler(err => { endLoading(); loadPage('Dashboard'); }).loadData('Master_RT', 'ALL', 'SuperAdmin');
            } else {
                google.script.run.withSuccessHandler(res => {
                    if(res.success && res.data.length > 0) { globalSettings = res.data[0]; applySettingsToUI(); }
                    google.script.run.withSuccessHandler(res2 => {
                        if(res2.success) globalWarga = res2.data;
                        endLoading(); loadPage('Dashboard');
                    }).withFailureHandler(err => { endLoading(); loadPage('Dashboard'); }).loadData('Warga', currentUser.kodeRT, currentUser.role);
                }).withFailureHandler(err => { endLoading(); loadPage('Dashboard'); }).loadData('Pengaturan', currentUser.kodeRT, currentUser.role);
            }
        }

        function handleLogout() {
            localStorage.removeItem('rtAppUser');
            currentUser = null;
            checkLoginState(); 
        }

        function handleLogin(event) {
            event.preventDefault();
            if (!checkGAS()) return;

            const u = document.getElementById('login_username').value;
            const p = document.getElementById('login_password').value;
            startLoading("Memverifikasi Akun...");

            google.script.run
                .withSuccessHandler(res => {
                    endLoading(); 
                    if (res.success) {
                        currentUser = res.user;
                        localStorage.setItem('rtAppUser', JSON.stringify(currentUser));
                        checkLoginState();
                    } else { Swal.fire('Gagal', res.message, 'error'); }
                })
                .withFailureHandler(err => { endLoading(); Swal.fire('Error Koneksi', 'Silakan coba lagi.', 'error'); })
                .loginUser({username: u, password: p});
        }

        // --- FETCH GLOBAL DATA ---
        function fetchGlobalMasterRT() {
            if (!checkGAS()) return;
            google.script.run.withSuccessHandler(res => { if(res.success) globalMasterRT = res.data; }).loadData('Master_RT', 'ALL', 'SuperAdmin');
        }

        function fetchGlobalWarga() {
            if (!checkGAS()) return;
            google.script.run.withSuccessHandler(res => { if(res.success) globalWarga = res.data; }).loadData('Warga', currentUser.kodeRT, currentUser.role);
        }

        function fetchGlobalSettings() {
            if (!checkGAS()) return;
            google.script.run.withSuccessHandler(res => {
                if(res.success && res.data.length > 0) { globalSettings = res.data[0]; applySettingsToUI(); }
            }).loadData('Pengaturan', currentUser.kodeRT, currentUser.role);
        }

        function applySettingsToUI() {
            if(globalSettings.NamaAplikasi) {
                document.title = globalSettings.NamaAplikasi;
                let loginName = document.getElementById('login-app-name');
                if(loginName) loginName.innerText = globalSettings.NamaAplikasi;
                let sidebarName = document.getElementById('sidebar-app-name');
                if(sidebarName) sidebarName.innerHTML = `<i class="fas fa-cube text-primary me-2"></i>${globalSettings.NamaAplikasi}`;
                let cardOrgName = document.getElementById('card-org-name');
                if(cardOrgName) cardOrgName.innerText = globalSettings.NamaAplikasi;
            }
            if(globalSettings.LogoUrl) {
                let loginLogo = document.getElementById('login-app-logo');
                if(loginLogo) loginLogo.innerHTML = `<img src="${globalSettings.LogoUrl}" style="max-height:80px; max-width:150px; object-fit:contain; margin-bottom:15px;">`;
            }
        }

        // --- NAVIGATION & UI ---
        function renderMenu() {
            const menuEl = document.getElementById('sidebar-menu');
            let menus = [{name: 'Dashboard', icon: 'fa-chart-bar', roles: ['ALL']}];

            if (currentUser.role === 'SuperAdmin') {
                menus.push({name: 'Manajemen RT', icon: 'fa-building', roles: ['SuperAdmin']});
                menus.push({name: 'Manajemen Akun', icon: 'fa-users-cog', roles: ['SuperAdmin']});
            } else if (['Admin', 'RT'].includes(currentUser.role)) {
                menus.push({name: 'Data Warga', icon: 'fa-users', roles: ['Admin']});
                menus.push({name: 'Surat Menyurat', icon: 'fa-envelope-open-text', roles: ['Admin']});
                menus.push({name: 'Input Pembayaran', icon: 'fa-cash-register', roles: ['Admin']});
                menus.push({name: 'Data Iuran', icon: 'fa-file-invoice-dollar', roles: ['Admin']});
                menus.push({name: 'Rekap Iuran', icon: 'fa-clipboard-check', roles: ['Admin']});
                menus.push({name: 'Data Kas', icon: 'fa-wallet', roles: ['Admin']});
                menus.push({name: 'Laporan Bulanan', icon: 'fa-chart-pie', roles: ['Admin']});
                menus.push({name: 'Manajemen Akun', icon: 'fa-user-shield', roles: ['Admin']}); 
                menus.push({name: 'Pengaturan', icon: 'fa-sliders-h', roles: ['Admin']}); 
            } else if (currentUser.role === 'Bendahara') {
                menus.push({name: 'Input Pembayaran', icon: 'fa-cash-register', roles: ['Bendahara']});
                menus.push({name: 'Data Iuran', icon: 'fa-file-invoice-dollar', roles: ['Bendahara']});
                menus.push({name: 'Rekap Iuran', icon: 'fa-clipboard-check', roles: ['Bendahara']});
                menus.push({name: 'Data Kas', icon: 'fa-wallet', roles: ['Bendahara']});
                menus.push({name: 'Laporan Bulanan', icon: 'fa-chart-pie', roles: ['Bendahara']});
            } else if (currentUser.role === 'Koordinator') {
                menus.push({name: 'Input Pembayaran', icon: 'fa-cash-register', roles: ['Koordinator']});
                menus.push({name: 'Data Iuran', icon: 'fa-file-invoice-dollar', roles: ['Koordinator']});
                menus.push({name: 'Rekap Iuran', icon: 'fa-clipboard-check', roles: ['Koordinator']});
            } else if (currentUser.role === 'Warga') {
                menus.push({name: 'Data Kas', icon: 'fa-wallet', roles: ['Warga']});
                menus.push({name: 'Riwayat Iuran Sampah', icon: 'fa-history', roles: ['Warga']});
            }

            let html = '';
            menus.forEach(m => {
                html += `<li class="nav-item">
                    <a class="nav-link ${m.name === activeMenu ? 'active' : ''}" onclick="loadPage('${m.name}')">
                        <i class="fas ${m.icon} fa-fw me-2 opacity-75"></i> ${m.name}
                    </a>
                </li>`;
            });
            menuEl.innerHTML = html;
        }

        function toggleSidebar() {
            document.getElementById('app-sidebar').classList.toggle('show');
            document.getElementById('sidebar-overlay').classList.toggle('show');
        }

        function loadPage(pageName) {
            activeMenu = pageName;
            document.getElementById('page-title').innerText = pageName;
            renderMenu(); 

            let sidebar = document.getElementById('app-sidebar');
            let overlay = document.getElementById('sidebar-overlay');
            if(sidebar && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
            
            if (pageName === 'Dashboard') {
                renderDashboardLoading(); fetchDashboardStats();
            } else if (pageName === 'Manajemen RT') {
                currentSheet = 'Master_RT'; renderTableUI(['Kode RT', 'Nama Lingkungan', 'Ketua RT']); fetchData('Master_RT');
            } else if (pageName === 'Manajemen Akun') {
                currentSheet = 'Users'; 
                let headers = currentUser.role === 'SuperAdmin' ? ['Username', 'Nama Pengguna', 'Peran', 'Kode RT'] : ['Username', 'Nama Pengguna', 'Peran'];
                renderTableUI(headers); fetchData('Users');
            } else if (pageName === 'Surat Menyurat') {
                currentSheet = 'Surat'; renderTableUI(['Tanggal', 'No. Surat', 'Nama Warga', 'Jenis Surat', 'Keperluan']); fetchData('Surat');
            } else if (pageName === 'Input Pembayaran') {
                currentSheet = 'Iuran'; renderInputPembayaranUI();
            } else if (pageName === 'Data Warga') {
                currentSheet = 'Warga'; renderTableUI(['NIK', 'Nama Lengkap', 'Blok', 'No HP', 'Status']); fetchData('Warga');
            } else if (pageName === 'Data Iuran' || pageName === 'Riwayat Iuran Sampah') {
                currentSheet = 'Iuran'; renderTableUI(['Tanggal', 'Nama Warga', 'Jenis Iuran', 'Bulan', 'Nominal', 'Status']); fetchData('Iuran');
            } else if (pageName === 'Data Kas') {
                currentSheet = 'Kas'; renderTableUI(['Tanggal', 'Jenis Kas', 'Nominal', 'Keterangan']); fetchData('Kas');
            } else if (pageName === 'Rekap Iuran') {
                currentSheet = 'Rekap'; renderRekapIuranUI();
            } else if (pageName === 'Laporan Bulanan') {
                currentSheet = 'Laporan'; renderLaporanBulananUI();
            } else if (pageName === 'Pengaturan') {
                currentSheet = 'Pengaturan'; renderPengaturanUI();
            }
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboardLoading() {
            document.getElementById('main-content').innerHTML = `<div class="text-center py-5 mt-5"><div class="spinner-border text-primary" role="status"></div><p class="text-muted mt-3">Menyiapkan Dashboard...</p></div>`;
        }

        function fetchDashboardStats() {
            if (!checkGAS()) return;
            google.script.run
                .withSuccessHandler(res => { if(res.success) renderDashboard(res.data); })
                .getDashboardData(currentUser.kodeRT, currentUser.role);
        }

        function renderDashboard(stats) {
            if(stats.isSuper) {
                document.getElementById('main-content').innerHTML = `
                    <div class="mb-4"><h4 class="fw-bold">Selamat Datang, Super Admin! üëë</h4><p class="text-muted">Pusat Kendali Seluruh RT Terdaftar</p></div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><div class="card card-custom bg-grad-dark text-white p-4">
                            <h6 class="opacity-75"><i class="fas fa-building me-2"></i>Total Wilayah RT Terdaftar</h6><h1 class="display-4 fw-bold mb-0">${stats.totalRT}</h1>
                        </div></div>
                        <div class="col-md-6"><div class="card card-custom bg-grad-success text-white p-4">
                            <h6 class="opacity-75"><i class="fas fa-users me-2"></i>Total Warga Keseluruhan</h6><h1 class="display-4 fw-bold mb-0">${stats.totalSemuaWarga}</h1>
                        </div></div>
                    </div>
                `;
                return;
            }

            let formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
            let appName = globalSettings.NamaAplikasi || 'Lingkungan Kita';
            
            let wargaCards = currentUser.role !== 'Warga' ? `
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6"><div class="card dash-card card-custom bg-grad-primary text-white p-3">
                        <h6 class="mb-1 opacity-75 small">Warga Aktif</h6><h2 class="mb-0 fw-bold">${stats.totalWarga}</h2>
                    </div></div>
                    <div class="col-md-3 col-6"><div class="card dash-card card-custom bg-grad-success text-white p-3">
                        <h6 class="mb-1 opacity-75 small">Warga Tetap</h6><h2 class="mb-0 fw-bold">${stats.tetap}</h2>
                    </div></div>
                    <div class="col-md-3 col-6"><div class="card dash-card card-custom bg-grad-warning text-dark p-3">
                        <h6 class="mb-1 opacity-75 small">Ngontrak</h6><h2 class="mb-0 fw-bold">${stats.kontrak}</h2>
                    </div></div>
                    <div class="col-md-3 col-6"><div class="card dash-card card-custom bg-grad-info text-white p-3">
                        <h6 class="mb-1 opacity-75 small">Domisili</h6><h2 class="mb-0 fw-bold">${stats.domisili}</h2>
                    </div></div>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-5">
                        <div class="card card-custom p-3 h-100">
                            <h6 class="fw-bold text-center mb-3 text-secondary small">Statistik Status Warga</h6>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="chartWarga"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card card-custom p-3 h-100">
                            <h6 class="fw-bold text-center mb-3 text-secondary small">Pemasukan vs Pengeluaran Kas</h6>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="chartKas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';
            
            document.getElementById('main-content').innerHTML = `
                <div class="mb-4">
                    <h4 class="fw-bold text-dark">Selamat Datang, ${currentUser.nama}! üëã</h4>
                    <p class="text-muted">Ringkasan data <b>${appName}</b></p>
                </div>
                ${wargaCards}
                <div class="card card-custom p-4 border-0 border-start border-success border-5 bg-white">
                    <h6 class="text-muted mb-2 text-uppercase fw-bold small"><i class="fas fa-wallet me-2"></i>Total Saldo Kas Terkini</h6>
                    <h2 class="mb-0 fw-bold text-success">${formatter.format(stats.saldoKas)}</h2>
                </div>
            `;

            if (currentUser.role !== 'Warga') {
                setTimeout(() => {
                    new Chart(document.getElementById('chartWarga'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Warga Tetap', 'Ngontrak', 'Domisili'],
                            datasets: [{
                                data: [stats.tetap, stats.kontrak, stats.domisili],
                                backgroundColor: ['#34d399', '#fbbf24', '#38bdf8'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {boxWidth: 12} } }, cutout: '70%' }
                    });

                    new Chart(document.getElementById('chartKas'), {
                        type: 'bar',
                        data: {
                            labels: ['Pemasukan Kas', 'Pengeluaran Kas'],
                            datasets: [{
                                label: 'Nominal Rupiah',
                                data: [stats.totalPemasukan, stats.totalPengeluaran],
                                backgroundColor: ['#34d399', '#f87171'],
                                borderRadius: 6,
                                barThickness: 40
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, border:{display:false} }, x: { grid: {display: false} } } }
                    });
                }, 200);
            }
        }

        // --- TABLE UI & CRUD ---
        function renderTableUI(headers) {
            let btnAdd = '';
            if (currentUser.role !== 'Warga') {
                btnAdd = `<button class="btn btn-primary" onclick="showForm()"><i class="fas fa-plus me-1"></i> Tambah Data</button>`;
            }
            let thHtml = headers.map(h => `<th>${h}</th>`).join('');
            let actionsTh = (currentUser.role !== 'Warga' || currentSheet === 'Surat') ? `<th class="text-center">Aksi</th>` : '';

            document.getElementById('main-content').innerHTML = `
                <div class="card card-custom p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0 fw-bold text-dark"><i class="fas fa-table text-primary me-2 opacity-75"></i> Data ${activeMenu}</h5>
                        ${btnAdd}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle"><thead class="table-light"><tr>${thHtml}${actionsTh}</tr></thead><tbody id="table-body"></tbody></table>
                    </div>
                </div>
            `;
        }

        function fetchData(sheetName) {
            if (!checkGAS()) return;
            google.script.run
                .withSuccessHandler(res => {
                    if(res.success) {
                        let data = res.data;
                        if(currentUser.role === 'Warga' && sheetName === 'Iuran') {
                            data = data.filter(d => d.NamaWarga && d.NamaWarga.includes(currentUser.nama) && d.JenisIuran === 'Iuran Sampah');
                        }
                        renderTableData(data);
                    }
                })
                .loadData(sheetName, currentUser.kodeRT, currentUser.role);
        }

        function renderTableData(dataArray) {
            const tbody = document.getElementById('table-body');
            if (!tbody) return; 
            if (!dataArray || dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-5"><i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><br>Belum ada data</td></tr>`; return;
            }

            let formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
            let html = '';
            dataArray.forEach(row => {
                let tds = '';
                Object.keys(row).forEach(key => {
                    if (key === 'Password') return; 
                    if (key !== 'ID' && key !== 'FotoUrl' && key !== 'KodeRT') { 
                        if(key === 'Nominal') tds += `<td class="fw-medium">${formatter.format(row[key])}</td>`;
                        else if(key === 'StatusPembayaran') tds += `<td><span class="badge ${row[key] === 'Lunas' ? 'bg-success' : 'bg-danger'} fw-normal px-2 py-1 rounded-pill">${row[key]}</span></td>`;
                        else if(key === 'Jenis' && currentSheet === 'Kas') tds += `<td><span class="badge ${row[key] === 'Pemasukan' ? 'bg-success' : 'bg-danger'} fw-normal px-2 py-1 rounded-pill">${row[key]}</span></td>`;
                        else if(key === 'Role' && currentSheet === 'Users') tds += `<td><span class="badge bg-primary bg-opacity-10 text-primary fw-medium px-2 py-1">${row[key]}</span></td>`;
                        else if(key === 'Status' && currentSheet === 'Warga') {
                             let bc = row[key] === 'Tetap' ? 'bg-success' : (row[key] === 'Pindah' ? 'bg-danger' : 'bg-info text-dark');
                             tds += `<td><span class="badge ${bc} fw-normal px-2 py-1 rounded-pill">${row[key]}</span></td>`;
                        } else tds += `<td>${row[key]}</td>`;
                    } else if (currentSheet === 'Users' && key === 'KodeRT' && currentUser.role === 'SuperAdmin') {
                        tds += `<td><span class="text-muted small">${row[key]}</span></td>`;
                    }
                });

                let rowDataStr = encodeURIComponent(JSON.stringify(row));
                let actionBtns = '';
                
                let cetakSuratBtn = currentSheet === 'Surat' ? `<button class="btn btn-sm btn-light text-primary me-1 border" onclick="showSurat('${rowDataStr}')" title="Cetak Surat"><i class="fas fa-print"></i> Cetak</button>` : '';

                if (currentUser.role === 'SuperAdmin' && currentSheet === 'Master_RT') {
                    actionBtns = `<td class="text-center"><button class="btn btn-sm btn-light text-warning me-1 border" onclick="showForm('${rowDataStr}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-light text-danger border" onclick="hapusData('${row.ID}')"><i class="fas fa-trash"></i></button></td>`;
                } else if (currentUser.role !== 'Warga' && currentUser.role !== 'SuperAdmin') {
                    let idCardBtn = currentSheet === 'Warga' ? `<button class="btn btn-sm btn-light text-info me-1 border" onclick="showCard('${rowDataStr}')" title="Lihat Kartu Warga"><i class="fas fa-id-card"></i></button>` : '';
                    actionBtns = `<td class="text-center" style="white-space:nowrap;">${cetakSuratBtn}${idCardBtn}<button class="btn btn-sm btn-light text-warning me-1 border" onclick="showForm('${rowDataStr}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-light text-danger border" onclick="hapusData('${row.ID}')"><i class="fas fa-trash"></i></button></td>`;
                } else if (currentSheet === 'Surat') {
                     actionBtns = `<td class="text-center">${cetakSuratBtn}</td>`;
                }
                html += `<tr>${tds}${actionBtns}</tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- FORM HANDLING ---
        function showForm(rowDataStr = null, isQuickPay = false) {
            const formInputs = document.getElementById('form-inputs');
            document.getElementById('modalTitle').innerHTML = rowDataStr && !isQuickPay ? '<i class="fas fa-edit text-warning me-2"></i>Edit Data' : '<i class="fas fa-plus-circle text-primary me-2"></i>Tambah Data Baru';
            
            let data = null;
            if (rowDataStr) { data = JSON.parse(decodeURIComponent(rowDataStr)); }

            let html = `<input type="hidden" id="form_ID" value="${data ? data.ID : ''}">`;

            if (currentSheet === 'Master_RT') {
                html += `
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Kode RT (Unik)</label><input type="text" class="form-control" id="rt_Kode" value="${data?data.KodeRT:''}" placeholder="Contoh: RT04" required></div>
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Nama Lingkungan</label><input type="text" class="form-control" id="rt_Nama" value="${data?data.NamaRT:''}" placeholder="Contoh: RT 04 Perum Indah" required></div>
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Nama Ketua RT</label><input type="text" class="form-control" id="rt_Ketua" value="${data?data.KetuaRT:''}" required></div>
                `;
            } else if (currentSheet === 'Users') {
                let roleOptions = '';
                let rtOptions = '';
                
                if (currentUser.role === 'SuperAdmin') {
                    roleOptions = `<option value="Admin" ${data&&data.Role=='Admin'?'selected':''}>Admin RT</option>`;
                    rtOptions = `<div class="mb-3"><label class="form-label small fw-bold text-muted">Penempatan Kode RT</label><select class="form-select" id="form_KodeRT" required><option value="">-- Pilih RT --</option>`;
                    globalMasterRT.forEach(rt => {
                        rtOptions += `<option value="${rt.KodeRT}" ${data && data.KodeRT === rt.KodeRT ? 'selected' : ''}>${rt.KodeRT} - ${rt.NamaRT}</option>`;
                    });
                    rtOptions += `</select></div>`;
                } else {
                    roleOptions = `
                        <option value="Bendahara" ${data&&data.Role=='Bendahara'?'selected':''}>Bendahara</option>
                        <option value="Koordinator" ${data&&data.Role=='Koordinator'?'selected':''}>Koordinator Pembayaran</option>
                        <option value="Warga" ${data&&data.Role=='Warga'?'selected':''}>Warga</option>
                    `;
                }

                html += `
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Username / NIK</label><input type="text" class="form-control" id="form_Username" value="${data?data.Username:''}" placeholder="Hindari pakai spasi" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Password</label><input type="text" class="form-control" id="form_Password" value="${data?data.Password:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Nama Pengguna Lengkap</label><input type="text" class="form-control" id="form_Nama" value="${data?data.Nama:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Peran (Role)</label><select class="form-select" id="form_Role" required>${roleOptions}</select></div>
                    ${rtOptions}
                `;
            } else if (currentSheet === 'Warga') {
                html += `
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">NIK</label><input type="text" class="form-control" id="form_NIK" value="${data?data.NIK:''}" required></div>
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Nama Lengkap</label><input type="text" class="form-control" id="form_NamaLengkap" value="${data?data.NamaLengkap:''}" required></div>
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Blok/No Rumah</label><input type="text" class="form-control" id="form_BlokRumah" value="${data?data.BlokRumah:''}" required></div>
                    <div class="mb-3"><label class="form-label text-muted small fw-bold">Status Warga</label>
                        <select class="form-select" id="form_Status">
                            <option value="Tetap" ${data&&data.Status=='Tetap'?'selected':''}>Warga Tetap</option>
                            <option value="Kontrak" ${data&&data.Status=='Kontrak'?'selected':''}>Warga Ngontrak</option>
                            <option value="Domisili" ${data&&data.Status=='Domisili'?'selected':''}>Domisili</option>
                            <option value="Pindah" ${data&&data.Status=='Pindah'?'selected':''}>Pindah / Keluar</option>
                        </select>
                    </div>`;
            } else if (currentSheet === 'Surat') {
                let wargaOptions = `<option value="">-- Pilih Warga --</option>`;
                globalWarga.filter(w => w.Status !== 'Pindah').forEach(w => {
                    let selected = (data && data.NamaWarga === w.NamaLengkap) ? 'selected' : '';
                    wargaOptions += `<option value="${w.NamaLengkap}" ${selected}>${w.NamaLengkap} (${w.BlokRumah})</option>`;
                });
                html += `
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Tanggal</label><input type="date" class="form-control" id="form_Tanggal" value="${data?data.Tanggal:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">No. Surat</label><input type="text" class="form-control" id="form_NomorSurat" value="${data?data.NomorSurat:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Nama Warga</label><select class="form-select" id="form_NamaWarga" required>${wargaOptions}</select></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Jenis Surat</label>
                        <select class="form-select" id="form_JenisSurat" required>
                            <option value="Surat Pengantar RT" ${data&&data.JenisSurat=='Surat Pengantar RT'?'selected':''}>Surat Pengantar RT</option>
                            <option value="Surat Keterangan Domisili" ${data&&data.JenisSurat=='Surat Keterangan Domisili'?'selected':''}>Surat Keterangan Domisili</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Keperluan</label><input type="text" class="form-control" id="form_Keperluan" value="${data?data.Keperluan:''}" required></div>
                `;
            } else if (currentSheet === 'Iuran') {
                let wOpt = `<option value="">-- Pilih Warga --</option>`;
                globalWarga.filter(w => w.Status !== 'Pindah').forEach(w => { wOpt += `<option value="${w.NamaLengkap}" ${(data && data.NamaWarga === w.NamaLengkap)?'selected':''}>${w.NamaLengkap}</option>`; });
                html += `
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Tanggal</label><input type="date" class="form-control" id="form_Tanggal" value="${data?data.Tanggal:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Nama Warga</label><select class="form-select" id="form_NamaWarga" required>${wOpt}</select></div>
                    <div class="row">
                        <div class="col-6 mb-3"><label class="form-label small fw-bold text-muted">Jenis</label><select class="form-select" id="form_JenisIuran" required><option value="Iuran Sampah" ${data&&data.JenisIuran=='Iuran Sampah'?'selected':''}>Iuran Sampah</option><option value="Kas Bulanan" ${data&&data.JenisIuran=='Kas Bulanan'?'selected':''}>Kas Bulanan</option></select></div>
                        <div class="col-6 mb-3"><label class="form-label small fw-bold text-muted">Bulan Tagihan</label><input type="month" class="form-control" id="form_BulanTagihan" value="${data?data.BulanTagihan:''}" required></div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Nominal</label><input type="number" class="form-control" id="form_Nominal" value="${data?data.Nominal:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Status</label><select class="form-select" id="form_StatusPembayaran"><option value="Lunas" ${data&&data.StatusPembayaran=='Lunas'?'selected':''}>Lunas</option><option value="Belum Lunas" ${data&&data.StatusPembayaran=='Belum Lunas'?'selected':''}>Belum Lunas</option></select></div>
                `;
            } else if (currentSheet === 'Kas') {
                html += `
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Tanggal</label><input type="date" class="form-control" id="form_Tanggal" value="${data?data.Tanggal:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Jenis</label><select class="form-select" id="form_Jenis" required><option value="Pemasukan" ${data&&data.Jenis=='Pemasukan'?'selected':''}>Pemasukan (+)</option><option value="Pengeluaran" ${data&&data.Jenis=='Pengeluaran'?'selected':''}>Pengeluaran (-)</option></select></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Nominal</label><input type="number" class="form-control" id="form_Nominal" value="${data?data.Nominal:''}" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">Keterangan</label><input type="text" class="form-control" id="form_Keterangan" value="${data?data.Keterangan:''}" required></div>
                `;
            }

            formInputs.innerHTML = html;
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            if (!checkGAS()) return;
            
            let formData = { ID: document.getElementById('form_ID').value };
            
            if (currentSheet === 'Master_RT') {
                formData.KodeRT = document.getElementById('rt_Kode').value;
                formData.NamaRT = document.getElementById('rt_Nama').value;
                formData.KetuaRT = document.getElementById('rt_Ketua').value;
            } else if (currentSheet === 'Users') {
                formData.Username = document.getElementById('form_Username').value;
                formData.Password = document.getElementById('form_Password').value;
                formData.Nama = document.getElementById('form_Nama').value;
                formData.Role = document.getElementById('form_Role').value;
                formData.KodeRT = currentUser.role === 'SuperAdmin' ? document.getElementById('form_KodeRT').value : currentUser.kodeRT;
            } else if (currentSheet === 'Warga') {
                formData.NIK = document.getElementById('form_NIK').value;
                formData.NamaLengkap = document.getElementById('form_NamaLengkap').value;
                formData.BlokRumah = document.getElementById('form_BlokRumah').value;
                formData.Status = document.getElementById('form_Status').value;
                formData.KodeRT = currentUser.kodeRT;
            } else if (currentSheet === 'Surat') {
                formData.Tanggal = document.getElementById('form_Tanggal').value;
                formData.NomorSurat = document.getElementById('form_NomorSurat').value;
                formData.NamaWarga = document.getElementById('form_NamaWarga').value;
                formData.JenisSurat = document.getElementById('form_JenisSurat').value;
                formData.Keperluan = document.getElementById('form_Keperluan').value;
                formData.KodeRT = currentUser.kodeRT;
            } else if (currentSheet === 'Iuran') {
                formData.Tanggal = document.getElementById('form_Tanggal').value;
                formData.NamaWarga = document.getElementById('form_NamaWarga').value;
                formData.JenisIuran = document.getElementById('form_JenisIuran').value;
                formData.BulanTagihan = document.getElementById('form_BulanTagihan').value;
                formData.Nominal = document.getElementById('form_Nominal').value;
                formData.StatusPembayaran = document.getElementById('form_StatusPembayaran').value;
                formData.KodeRT = currentUser.kodeRT;
            } else if (currentSheet === 'Kas') {
                formData.Tanggal = document.getElementById('form_Tanggal').value;
                formData.Jenis = document.getElementById('form_Jenis').value;
                formData.Nominal = document.getElementById('form_Nominal').value;
                formData.Keterangan = document.getElementById('form_Keterangan').value;
                formData.KodeRT = currentUser.kodeRT;
            }

            startLoading("Menyimpan data...");
            bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();

            google.script.run
                .withSuccessHandler(res => {
                    endLoading(); 
                    if(res.success) { 
                        Swal.fire('Berhasil', res.message, 'success'); 
                        if(currentSheet === 'Master_RT') fetchGlobalMasterRT();
                        if(activeMenu === 'Rekap Iuran') generateRekap(); else fetchData(currentSheet); 
                    } else { Swal.fire('Gagal', res.message, 'error'); }
                })
                .simpanData(currentSheet, formData);
        }

        function hapusData(id) {
            if (!checkGAS()) return;
            Swal.fire({ title: 'Hapus Data?', text: "Data terhapus permanen!", icon: 'warning', showCancelButton: true, confirmButtonText: 'Hapus' }).then((result) => {
                if (result.isConfirmed) {
                    startLoading("Menghapus data...");
                    google.script.run.withSuccessHandler(res => { endLoading(); fetchData(currentSheet); }).hapusData(currentSheet, id);
                }
            });
        }

        // --- PENGATURAN UI ---
        function renderPengaturanUI() {
            let appName = globalSettings.NamaAplikasi || '';
            let currentLogo = globalSettings.LogoUrl || '';
            let namaRT = globalSettings.NamaKetuaRT || '';
            let namaBen = globalSettings.NamaBendahara || '';
            let namaRW = globalSettings.NamaKetuaRW || '';
            let logoPreview = currentLogo ? `<img src="${currentLogo}" style="max-height: 120px; max-width: 100%; border-radius: 8px;">` : `<div class="text-muted small"><i class="fas fa-image fa-2x mb-2 opacity-50"></i><br>Belum ada logo</div>`;

            document.getElementById('main-content').innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-7">
                        <div class="card card-custom p-4 border-top border-primary border-4">
                            <h5 class="mb-4 fw-bold text-dark"><i class="fas fa-cogs text-primary me-2"></i>Pengaturan Aplikasi</h5>
                            <form id="formPengaturan" onsubmit="handlePengaturanSubmit(event)">
                                <div class="mb-3"><label class="form-label fw-bold small text-muted">Nama Instansi / Aplikasi</label><input type="text" class="form-control" id="peng_NamaAplikasi" value="${appName}" required></div>
                                <div class="row">
                                    <div class="col-md-6 mb-3"><label class="form-label fw-bold small text-muted">Nama Ketua RT</label><input type="text" class="form-control" id="peng_NamaKetuaRT" value="${namaRT}"></div>
                                    <div class="col-md-6 mb-3"><label class="form-label fw-bold small text-muted">Nama Bendahara</label><input type="text" class="form-control" id="peng_NamaBendahara" value="${namaBen}"></div>
                                </div>
                                <div class="mb-3"><label class="form-label fw-bold small text-muted">Nama Ketua RW</label><input type="text" class="form-control" id="peng_NamaKetuaRW" value="${namaRW}"></div>
                                <div class="mb-4"><label class="form-label fw-bold small text-muted">Logo Kop Surat</label>
                                    <div class="text-center p-3 border rounded bg-light mb-2" id="logo-preview-container">${logoPreview}</div>
                                    <input type="file" class="form-control" id="peng_LogoUrl" accept="image/*">
                                </div>
                                <hr class="border-light">
                                <div class="text-end"><button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i> Simpan Pengaturan</button></div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function handlePengaturanSubmit(event) {
            event.preventDefault();
            if (!checkGAS()) return;
            
            let newName = document.getElementById('peng_NamaAplikasi').value;
            let nRT = document.getElementById('peng_NamaKetuaRT').value;
            let nBen = document.getElementById('peng_NamaBendahara').value;
            let nRW = document.getElementById('peng_NamaKetuaRW').value;
            let file = document.getElementById('peng_LogoUrl').files[0];
            startLoading("Menyimpan Pengaturan...");

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; let scaleSize = 1;
                        if(img.width > MAX_WIDTH) { scaleSize = MAX_WIDTH / img.width; }
                        canvas.width = img.width * scaleSize; canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const base64Data = canvas.toDataURL('image/png', 0.9);

                        google.script.run.withSuccessHandler(res => { if(res.success) finalizeSavePengaturan(newName, res.url, nRT, nBen, nRW); else endLoading(); }).uploadLogoAplikasi(base64Data, 'image/png', currentUser.kodeRT);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else { finalizeSavePengaturan(newName, globalSettings.LogoUrl, nRT, nBen, nRW); }
        }

        function finalizeSavePengaturan(newName, logoUrl, namaRT, namaBendahara, namaRW) {
            let formData = { ID: "1", NamaAplikasi: newName, LogoUrl: logoUrl || '', NamaKetuaRT: namaRT, NamaBendahara: namaBendahara, NamaKetuaRW: namaRW, KodeRT: currentUser.kodeRT };
            google.script.run.withSuccessHandler(res => {
                endLoading(); if (res.success) { globalSettings = formData; applySettingsToUI(); renderPengaturanUI(); Swal.fire('Berhasil', 'Pengaturan berhasil diperbarui!', 'success'); }
            }).simpanData('Pengaturan', formData);
        }

        // --- LAPORAN BULANAN (MINIMALIS) ---
        function renderLaporanBulananUI() {
            let todayMonth = new Date().toISOString().slice(0,7);
            document.getElementById('main-content').innerHTML = `
                <div class="card card-custom p-3 shadow-sm mb-4">
                    <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-chart-pie text-primary me-2"></i>Laporan Keuangan Bulanan</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1 fw-medium">Tipe Laporan</label>
                            <select id="lap_tipe" class="form-select">
                                <option value="Iuran">Laporan Iuran Warga</option>
                                <option value="Kas">Laporan Kas RT</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1 fw-medium">Bulan & Tahun</label>
                            <input type="month" id="lap_bulan" class="form-control" value="${todayMonth}">
                        </div>
                        <div class="col-md-6 d-flex gap-2">
                            <button class="btn btn-primary flex-grow-1" onclick="generateLaporan()"><i class="fas fa-search me-1"></i> Tampilkan</button>
                            <button class="btn btn-light border text-dark" onclick="cetakLaporan()"><i class="fas fa-print"></i> Cetak</button>
                            <button class="btn btn-success" onclick="downloadExcelLaporan()"><i class="fas fa-file-excel"></i> Excel</button>
                        </div>
                    </div>
                </div>
                <div id="laporan-print-area" class="card-custom" style="display:none; background:#fff; padding:30px; border-radius:12px; color:#333;"></div>
            `;
            generateLaporan();
        }

        function generateLaporan() {
            if (!checkGAS()) return;
            let bulan = document.getElementById('lap_bulan').value;
            let tipeLaporan = document.getElementById('lap_tipe').value;
            if(!bulan) return Swal.fire('Perhatian', 'Bulan wajib diisi', 'warning');

            startLoading("Menyiapkan Laporan...");

            google.script.run
                .withSuccessHandler(kRes => {
                    if(kRes.success) {
                        google.script.run
                            .withSuccessHandler(iRes => {
                                endLoading();
                                if(iRes.success) processLaporanData(kRes.data, iRes.data, bulan, tipeLaporan);
                                else Swal.fire('Gagal Memuat Iuran', iRes.message, 'error');
                            })
                            .withFailureHandler(err => { endLoading(); Swal.fire('Error', err.message, 'error'); })
                            .loadData('Iuran', currentUser.kodeRT, currentUser.role);
                    } else {
                        endLoading(); Swal.fire('Gagal Memuat Kas', kRes.message, 'error');
                    }
                })
                .withFailureHandler(err => { endLoading(); Swal.fire('Error', err.message, 'error'); })
                .loadData('Kas', currentUser.kodeRT, currentUser.role);
        }

        function processLaporanData(dataKas, dataIuran, filterBulan, tipeLaporan) {
            let formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
            let dateObj = new Date(filterBulan + '-01');
            let bulanIndo = dateObj.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            let appName = globalSettings.NamaAplikasi || 'RT/RW SETEMPAT';
            let tglCetak = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
            
            let namaRT = globalSettings.NamaKetuaRT || '....................................';
            let namaBendahara = globalSettings.NamaBendahara || '....................................';

            let totalKasInBefore = dataKas.filter(k => k.Tanggal && k.Tanggal.substring(0,7) < filterBulan && k.Jenis === 'Pemasukan').reduce((sum, k) => sum + (parseFloat(k.Nominal)||0), 0);
            let totalKasOutBefore = dataKas.filter(k => k.Tanggal && k.Tanggal.substring(0,7) < filterBulan && k.Jenis === 'Pengeluaran').reduce((sum, k) => sum + (parseFloat(k.Nominal)||0), 0);
            let saldoAwal = totalKasInBefore - totalKasOutBefore;
            
            let html = `
                <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-weight: bold; text-transform: uppercase; color: #1e293b;">LAPORAN ${tipeLaporan.toUpperCase()} BULANAN</h3>
                    <h5 style="margin: 5px 0 0 0; text-transform: uppercase; color: #475569;">${appName}</h5>
                    <p style="margin: 5px 0 0 0; color: #64748b;">Periode: <b>${bulanIndo}</b></p>
                </div>
            `;

            if (tipeLaporan === 'Iuran') {
                let iuranBulanIni = dataIuran.filter(i => i.Tanggal && i.Tanggal.startsWith(filterBulan) && i.StatusPembayaran === 'Lunas');
                iuranBulanIni.sort((a,b) => a.Tanggal.localeCompare(b.Tanggal)); 
                
                let totalIuran = 0;
                let rowIuran = '';
                
                iuranBulanIni.forEach((i, idx) => {
                    let nom = parseFloat(i.Nominal) || 0;
                    totalIuran += nom;
                    rowIuran += `<tr>
                        <td style="text-align: center; padding: 10px; border-bottom: 1px solid #e2e8f0;">${idx+1}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.Tanggal}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.NamaWarga}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.JenisIuran} (${i.BulanTagihan})</td>
                        <td style="text-align: right; color: #10b981; padding: 10px; border-bottom: 1px solid #e2e8f0;">${formatter.format(nom)}</td>
                        <td style="text-align: right; font-weight: 600; padding: 10px; border-bottom: 1px solid #e2e8f0;">${formatter.format(totalIuran)}</td>
                    </tr>`;
                });

                html += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #10b981; border-radius: 8px; text-align: center; background: #ecfdf5;">
                        <span style="font-size: 0.85rem; color: #047857; font-weight: 600;">Total Pemasukan Iuran Bulan Ini</span>
                        <h3 style="margin: 5px 0 0 0; color: #047857; font-weight: bold;">${formatter.format(totalIuran)}</h3>
                    </div>
                    <table id="table-export-excel" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem;">
                        <thead style="background: #f8fafc; border-bottom: 2px solid #cbd5e1;">
                            <tr>
                                <th style="padding:10px; color: #334155;">No</th><th style="padding:10px; color: #334155;">Tanggal Bayar</th>
                                <th style="padding:10px; color: #334155;">Nama Warga</th><th style="padding:10px; color: #334155;">Jenis Iuran</th>
                                <th style="padding:10px; text-align: right; color: #334155;">Nominal Masuk</th>
                                <th style="padding:10px; text-align: right; color: #334155;">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowIuran || `<tr><td colspan="6" style="text-align: center; padding: 15px; color: #64748b;">Belum ada pemasukan iuran di bulan ini</td></tr>`}
                        </tbody>
                        ${rowIuran ? `<tfoot style="background: #f8fafc; font-weight: bold; border-top: 2px solid #cbd5e1;"><tr><td colspan="4" style="text-align: right; padding:10px; color: #334155;">Total Pemasukan Iuran:</td><td colspan="2" style="text-align: right; padding:10px; color: #10b981;">${formatter.format(totalIuran)}</td></tr></tfoot>` : ''}
                    </table>
                `;
            } else {
                let kasBulanIni = dataKas.filter(k => k.Tanggal && k.Tanggal.startsWith(filterBulan));
                let transaksiBulanan = [];
                kasBulanIni.forEach(k => {
                    transaksiBulanan.push({
                        Tanggal: k.Tanggal,
                        Keterangan: k.Keterangan + (k.Jenis === 'Pemasukan' ? ' (Pemasukan Kas)' : ' (Pengeluaran Kas)'),
                        Masuk: k.Jenis === 'Pemasukan' ? (parseFloat(k.Nominal) || 0) : 0,
                        Keluar: k.Jenis === 'Pengeluaran' ? (parseFloat(k.Nominal) || 0) : 0
                    });
                });

                transaksiBulanan.sort((a,b) => a.Tanggal.localeCompare(b.Tanggal));
                
                let totalPemasukanBulanIni = 0;
                let totalPengeluaranBulanIni = 0;
                let currentSaldo = saldoAwal;
                
                let rowKas = `<tr>
                    <td colspan="5" style="text-align: right; font-weight: 600; padding: 10px; border-bottom: 1px solid #e2e8f0;">Saldo Awal Bulan Lalu:</td>
                    <td style="text-align: right; font-weight: 600; padding: 10px; color: #3b82f6; border-bottom: 1px solid #e2e8f0;">${formatter.format(saldoAwal)}</td>
                </tr>`;
                
                transaksiBulanan.forEach((t, idx) => {
                    totalPemasukanBulanIni += t.Masuk;
                    totalPengeluaranBulanIni += t.Keluar;
                    currentSaldo += (t.Masuk - t.Keluar);
                    
                    rowKas += `<tr>
                        <td style="text-align: center; padding: 10px; border-bottom: 1px solid #e2e8f0;">${idx+1}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${t.Tanggal}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${t.Keterangan}</td>
                        <td style="text-align: right; color: #10b981; padding: 10px; border-bottom: 1px solid #e2e8f0;">${t.Masuk > 0 ? formatter.format(t.Masuk) : '-'}</td>
                        <td style="text-align: right; color: #ef4444; padding: 10px; border-bottom: 1px solid #e2e8f0;">${t.Keluar > 0 ? formatter.format(t.Keluar) : '-'}</td>
                        <td style="text-align: right; font-weight: 600; padding: 10px; border-bottom: 1px solid #e2e8f0;">${formatter.format(currentSaldo)}</td>
                    </tr>`;
                });
                
                let saldoAkhir = currentSaldo;

                html += `
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
                        <div style="flex: 1; padding: 15px; border-radius: 8px; text-align: center; background: #f8fafc; border: 1px solid #e2e8f0;">
                            <span style="font-size: 0.8rem; color: #64748b;">Saldo Awal</span>
                            <h6 style="margin: 5px 0 0 0; color: #3b82f6; font-weight: 700;">${formatter.format(saldoAwal)}</h6>
                        </div>
                        <div style="flex: 1; padding: 15px; border-radius: 8px; text-align: center; background: #f8fafc; border: 1px solid #e2e8f0;">
                            <span style="font-size: 0.8rem; color: #64748b;">Masuk (Debit)</span>
                            <h6 style="margin: 5px 0 0 0; color: #10b981; font-weight: 700;">${formatter.format(totalPemasukanBulanIni)}</h6>
                        </div>
                        <div style="flex: 1; padding: 15px; border-radius: 8px; text-align: center; background: #f8fafc; border: 1px solid #e2e8f0;">
                            <span style="font-size: 0.8rem; color: #64748b;">Keluar (Kredit)</span>
                            <h6 style="margin: 5px 0 0 0; color: #ef4444; font-weight: 700;">${formatter.format(totalPengeluaranBulanIni)}</h6>
                        </div>
                        <div style="flex: 1; padding: 15px; border-radius: 8px; text-align: center; background: #ecfdf5; border: 1px solid #10b981;">
                            <span style="font-size: 0.8rem; color: #047857; font-weight: 600;">Saldo Akhir</span>
                            <h6 style="margin: 5px 0 0 0; color: #047857; font-weight: 700;">${formatter.format(saldoAkhir)}</h6>
                        </div>
                    </div>
                    <table id="table-export-excel" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead style="background: #f8fafc; border-bottom: 2px solid #cbd5e1;">
                            <tr>
                                <th style="padding:10px; color: #334155;">No</th><th style="padding:10px; color: #334155;">Tanggal</th>
                                <th style="padding:10px; color: #334155;">Keterangan / Uraian</th>
                                <th style="padding:10px; text-align: right; color: #334155;">Masuk (Debit)</th>
                                <th style="padding:10px; text-align: right; color: #334155;">Keluar (Kredit)</th>
                                <th style="padding:10px; text-align: right; color: #334155;">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transaksiBulanan.length > 0 ? rowKas : `<tr><td colspan="6" style="text-align: center; padding: 15px; color: #64748b;">Belum ada transaksi di bulan ini</td></tr>`}
                        </tbody>
                        ${transaksiBulanan.length > 0 ? `<tfoot style="background: #f8fafc; font-weight: bold; border-top: 2px solid #cbd5e1;"><tr><td colspan="3" style="text-align: right; padding:10px; color: #334155;">Total Bulan Ini / Saldo Akhir:</td><td style="text-align: right; padding:10px; color: #10b981;">${formatter.format(totalPemasukanBulanIni)}</td><td style="text-align: right; padding:10px; color: #ef4444;">${formatter.format(totalPengeluaranBulanIni)}</td><td style="text-align: right; padding:10px; color: #10b981;">${formatter.format(saldoAkhir)}</td></tr></tfoot>` : ''}
                    </table>
                `;
            }

            html += `
                <table style="width: 100%; margin-top: 60px; font-size: 0.9rem; color: #334155;">
                    <tr>
                        <td style="width: 50%; text-align: center;">
                            <p style="margin: 0;">Mengetahui,<br>Ketua RT</p>
                            <br><br><br><br>
                            <p style="margin: 0; font-weight: bold; text-decoration: underline;">${namaRT}</p>
                        </td>
                        <td style="width: 50%; text-align: center;">
                            <p style="margin: 0;">Dicetak pada: ${tglCetak}<br>Bendahara</p>
                            <br><br><br><br>
                            <p style="margin: 0; font-weight: bold; text-decoration: underline;">${namaBendahara}</p>
                        </td>
                    </tr>
                </table>
            `;
            
            let printArea = document.getElementById('laporan-print-area');
            printArea.innerHTML = html;
            printArea.style.display = 'block';
        }

        function cetakLaporan() {
            let area = document.getElementById('laporan-print-area');
            if (area.style.display === 'none' || area.innerHTML.trim() === '') {
                return Swal.fire('Perhatian', 'Silakan tampilkan laporan terlebih dahulu.', 'warning');
            }
            let printContent = area.innerHTML;
            let printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Cetak Laporan Keuangan</title>
                    <style>
                        body { font-family: 'Segoe UI', Arial, sans-serif; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; padding: 20px; color: #333; }
                        @media print { @page { margin: 1cm; size: A4 portrait; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script> window.onload = function() { setTimeout(() => { window.print(); window.close(); }, 800); }; <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function downloadExcelLaporan() {
            let table = document.getElementById('table-export-excel');
            if (!table) return Swal.fire('Perhatian', 'Silakan tampilkan laporan terlebih dahulu.', 'warning');
            
            let tipeLaporan = document.getElementById('lap_tipe').value;
            let bulan = document.getElementById('lap_bulan').value;
            let fileName = `Laporan_${tipeLaporan}_${bulan}.xlsx`;
            
            let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, fileName);
        }

        // --- INPUT PEMBAYARAN & REKAP ---
        function renderInputPembayaranUI() {
            let wargaOptions = '';
            globalWarga.filter(w => w.Status !== 'Pindah').forEach(w => {
                wargaOptions += `<option value="${w.NamaLengkap}">Blok: ${w.BlokRumah}</option>`;
            });
            let today = new Date().toISOString().slice(0,10);
            let currentMonth = today.slice(0,7);

            document.getElementById('main-content').innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-md-9 col-lg-8">
                        <div class="card card-custom p-4 border-top border-primary border-4">
                            <h5 class="mb-4 fw-bold text-dark"><i class="fas fa-cash-register text-primary me-2 opacity-75"></i>Input Pembayaran</h5>
                            <form id="formInputPembayaran" onsubmit="handleInputPembayaranSubmit(event)">
                                <div class="row g-3">
                                    <div class="col-md-6"><label class="form-label text-secondary small fw-bold mb-1">Tanggal Bayar</label><input type="date" class="form-control" id="ip_Tanggal" value="${today}" required></div>
                                    <div class="col-md-6">
                                        <label class="form-label text-secondary small fw-bold mb-1">Nama Warga / Blok</label>
                                        <input class="form-control" list="wargaListOptions" id="ip_NamaWarga" placeholder="Ketik nama atau blok..." required autocomplete="off">
                                        <datalist id="wargaListOptions">${wargaOptions}</datalist>
                                    </div>
                                    <div class="col-md-6"><label class="form-label text-secondary small fw-bold mb-1">Jenis Iuran</label><select class="form-select" id="ip_JenisIuran" required><option value="Iuran Sampah">Iuran Sampah</option><option value="Kas Bulanan">Kas Bulanan</option><option value="Keamanan">Keamanan</option></select></div>
                                    <div class="col-md-6"><label class="form-label text-secondary small fw-bold mb-1">Bulan Tagihan</label><input type="month" class="form-control" id="ip_BulanTagihan" value="${currentMonth}" required></div>
                                    <div class="col-md-6"><label class="form-label text-secondary small fw-bold mb-1">Nominal (Rp)</label><input type="number" class="form-control" id="ip_Nominal" placeholder="Contoh: 25000" required></div>
                                    <div class="col-md-6"><label class="form-label text-secondary small fw-bold mb-1">Status</label><select class="form-select" id="ip_StatusPembayaran"><option value="Lunas" selected>Lunas</option><option value="Belum Lunas">Belum Lunas</option></select></div>
                                    <div class="col-md-12"><label class="form-label text-secondary small fw-bold mb-1">Keterangan (Opsional)</label><input type="text" class="form-control" id="ip_Keterangan" placeholder="Contoh: Titip ke satpam"></div>
                                </div>
                                <hr class="border-light my-4">
                                <div class="text-end">
                                    <button type="button" class="btn btn-light border text-dark me-2" onclick="document.getElementById('formInputPembayaran').reset()">Reset</button>
                                    <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i> Simpan Data</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleInputPembayaranSubmit(event) {
            event.preventDefault();
            if (!checkGAS()) return;

            let formData = {
                ID: Date.now().toString(), Tanggal: document.getElementById('ip_Tanggal').value, NamaWarga: document.getElementById('ip_NamaWarga').value,
                JenisIuran: document.getElementById('ip_JenisIuran').value, BulanTagihan: document.getElementById('ip_BulanTagihan').value,
                Nominal: document.getElementById('ip_Nominal').value, Keterangan: document.getElementById('ip_Keterangan').value,
                StatusPembayaran: document.getElementById('ip_StatusPembayaran').value, KodeRT: currentUser.kodeRT
            };
            startLoading("Menyimpan pembayaran...");
            google.script.run.withSuccessHandler(res => {
                endLoading(); 
                if(res.success) { Swal.fire({ title: 'Berhasil', text: 'Pembayaran tersimpan ke server', icon: 'success', showCancelButton: true, confirmButtonText: 'Input Lagi', cancelButtonText: 'Ke Data Iuran' }).then((r) => { if (r.isConfirmed) document.getElementById('formInputPembayaran').reset(); else loadPage('Data Iuran'); }); } else { Swal.fire('Gagal', res.message, 'error'); }
            }).simpanData('Iuran', formData);
        }

        function renderRekapIuranUI() {
            let todayYear = new Date().getFullYear(); 
            document.getElementById('main-content').innerHTML = `
                <div class="card card-custom p-3 shadow-sm mb-4">
                    <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-clipboard-check text-primary me-2"></i>Rekapitulasi Tahunan</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1 fw-medium">Tahun Tagihan</label>
                            <input type="number" id="rekap_tahun" class="form-control" value="${todayYear}" min="2020" max="2050">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small text-muted mb-1 fw-medium">Jenis Iuran</label>
                            <select id="rekap_jenis" class="form-select">
                                <option value="Iuran Sampah">Iuran Sampah</option>
                                <option value="Kas Bulanan">Kas Bulanan</option>
                                <option value="Keamanan">Keamanan</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="generateRekap()"><i class="fas fa-search me-1"></i> Tampilkan</button>
                        </div>
                    </div>
                </div>
                <div id="rekap-table-container"><div class="text-center text-muted py-5 mt-4"><i class="fas fa-filter fa-3x mb-3 opacity-25"></i><br><small>Pilih tahun dan jenis iuran lalu klik Tampilkan</small></div></div>
            `;
            generateRekap();
        }

        function generateRekap() {
            if (!checkGAS()) return;
            let tahun = document.getElementById('rekap_tahun').value;
            let jenis = document.getElementById('rekap_jenis').value;
            if(!tahun || !jenis) return Swal.fire('Perhatian', 'Tahun dan Jenis wajib diisi', 'warning');
            
            startLoading("Menghitung Rekapitulasi...");
            google.script.run.withSuccessHandler(wRes => {
                if(wRes.success) {
                    globalWarga = wRes.data;
                    google.script.run.withSuccessHandler(iRes => {
                        endLoading(); if(iRes.success) processRekapData(globalWarga, iRes.data, tahun, jenis); else Swal.fire('Gagal', iRes.message, 'error');
                    }).loadData('Iuran', currentUser.kodeRT, currentUser.role);
                } else { endLoading(); Swal.fire('Gagal', wRes.message, 'error'); }
            }).loadData('Warga', currentUser.kodeRT, currentUser.role);
        }

        function processRekapData(dataWarga, dataIuran, filterTahun, filterJenis) {
            let wargaAktif = dataWarga.filter(w => w.Status !== 'Pindah' && w.Status !== '');
            let iuranTerkait = dataIuran.filter(i => i.JenisIuran === filterJenis && i.BulanTagihan && i.BulanTagihan.startsWith(filterTahun) && i.StatusPembayaran === 'Lunas');
            let html = `
                <div class="card card-custom p-4 shadow-sm border-0">
                    <h5 class="m-0 fw-bold mb-3 text-dark">Hasil Rekap: ${filterJenis} (Tahun ${filterTahun})</h5>
                    <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light">
                    <tr><th style="width: 5%;" class="text-center">No</th><th style="width: 25%;">Nama Warga</th><th style="width: 35%;">Bulan Lunas</th><th style="width: 35%;">Belum Bayar (Nunggak)</th></tr>
                    </thead><tbody>`;
            if(wargaAktif.length === 0) { html += `<tr><td colspan="4" class="text-center text-muted py-4">Belum ada data.</td></tr>`; } 
            else {
                const months = [{val: '01', name: 'Jan'}, {val: '02', name: 'Feb'}, {val: '03', name: 'Mar'}, {val: '04', name: 'Apr'}, {val: '05', name: 'Mei'}, {val: '06', name: 'Jun'}, {val: '07', name: 'Jul'}, {val: '08', name: 'Ags'}, {val: '09', name: 'Sep'}, {val: '10', name: 'Okt'}, {val: '11', name: 'Nov'}, {val: '12', name: 'Des'}];
                wargaAktif.forEach((warga, index) => {
                    let badgeLunas = '', badgeNunggak = '';
                    months.forEach(m => {
                        let targetBulan = `${filterTahun}-${m.val}`;
                        let isPaid = iuranTerkait.find(i => i.NamaWarga === warga.NamaLengkap && i.BulanTagihan === targetBulan);
                        if(isPaid) badgeLunas += `<span class="badge bg-success me-1 mb-1 shadow-sm fw-normal"><i class="fas fa-check"></i> ${m.name}</span>`;
                        else {
                            if(currentUser.role === 'Warga') badgeNunggak += `<span class="badge bg-danger me-1 mb-1 shadow-sm opacity-75 fw-normal">${m.name}</span>`;
                            else badgeNunggak += `<button class="btn btn-sm btn-outline-danger py-0 px-2 me-1 mb-1 shadow-sm" style="font-size:0.75rem; border-radius: 12px;" onclick="quickPay('${warga.NamaLengkap}', '${filterJenis}', '${targetBulan}')">Bayar ${m.name}</button>`;
                        }
                    });
                    if(!badgeLunas) badgeLunas = '<em class="text-muted small">Belum ada pembayaran</em>';
                    if(!badgeNunggak) badgeNunggak = '<span class="badge bg-primary fw-normal"><i class="fas fa-star text-warning"></i> Lunas 1 Tahun</span>';
                    html += `<tr><td class="text-center">${index + 1}</td><td><div class="fw-bold text-dark">${warga.NamaLengkap}</div><div class="small text-muted"><i class="fas fa-map-marker-alt"></i> Blok: ${warga.BlokRumah}</div></td><td>${badgeLunas}</td><td>${badgeNunggak}</td></tr>`;
                });
            }
            html += `</tbody></table></div></div>`;
            document.getElementById('rekap-table-container').innerHTML = html;
        }

        function quickPay(namaWarga, jenisIuran, bulanTagihan) {
            let prefilledData = { ID: '', Tanggal: new Date().toISOString().slice(0,10), NamaWarga: namaWarga, JenisIuran: jenisIuran, BulanTagihan: bulanTagihan, Nominal: '', Keterangan: 'Dibayar via Rekap', StatusPembayaran: 'Lunas', KodeRT: currentUser.kodeRT };
            currentSheet = 'Iuran'; new bootstrap.Modal(document.getElementById('formModal')).show();
            setTimeout(() => {
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-bolt text-warning me-2"></i>Bayar Cepat';
                document.getElementById('form_ID').value = '';
                document.getElementById('form_Tanggal').value = prefilledData.Tanggal;
                document.getElementById('form_NamaWarga').value = prefilledData.NamaWarga;
                document.getElementById('form_JenisIuran').value = prefilledData.JenisIuran;
                document.getElementById('form_BulanTagihan').value = prefilledData.BulanTagihan;
                document.getElementById('form_Nominal').value = '';
                document.getElementById('form_StatusPembayaran').value = 'Lunas';
            }, 300);
        }

    </script>
</body>
</html>